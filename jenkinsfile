pipeline {
    agent any

    triggers {
        githubPush()
    }

    tools {
        nodejs 'node18'
    }

    environment {
        FRONTEND_IMAGE = "namratha3/dd-mean-frontend"
        BACKEND_IMAGE  = "namratha3/dd-mean-backend"
        AWS_USER       = "ubuntu"                      
        AWS_IP         = "3.110.45.221"               
        SLACK_WEBHOOK  = credentials('slack-cred')
    }

    stages {

        stage('Notify Start') {
            steps {
                sh """
                curl -X POST -H 'Content-type: application/json' \
                --data '{"text": "üöÄ Pipeline Started"}' \
                '${SLACK_WEBHOOK}'
                """
            }
        }

        stage('Git Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/Namrathaaaaaa/crud-dd-task-mean-app.git'

                script {
                    env.IMAGE_TAG = sh(
                        script: "git rev-parse --short HEAD",
                        returnStdout: true
                    ).trim()
                }

                sh """
                curl -X POST -H 'Content-type: application/json' \
                --data '{"text": "üîñ New Docker Tag Created: ${IMAGE_TAG}"}' \
                '${SLACK_WEBHOOK}'
                """
            }
        }

        stage('Docker Login') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'docker-cred',
                    usernameVariable: 'DOCKER_USER',
                    passwordVariable: 'DOCKER_PASS'
                )]) {
                    sh 'echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin'
                }
            }
        }

        stage('Build Backend Image') {
            steps {
                sh """
                cd backend
                docker buildx build \
                    --platform linux/amd64 \
                    -t ${BACKEND_IMAGE}:${IMAGE_TAG} \
                    -t ${BACKEND_IMAGE}:latest \
                    --push .
                """
            }
        }

        stage('Build Frontend Image') {
            steps {
                sh """
                cd frontend
                docker buildx build \
                    --platform linux/amd64 \
                    -t ${FRONTEND_IMAGE}:${IMAGE_TAG} \
                    -t ${FRONTEND_IMAGE}:latest \
                    --push .
                """
            }
        }


        stage('Deploy to AWS EC2') {
            steps {
                withCredentials([sshUserPrivateKey(
                    credentialsId: 'aws-ssh-key',          
                    keyFileVariable: 'SSH_KEY'
                )]) {

                    sh """
                    ssh -i $SSH_KEY -o StrictHostKeyChecking=no ${AWS_USER}@${AWS_IP} '
                        /home/ubuntu/crud-dd-task-mean-app &&
                        
                        sed -i "s|${FRONTEND_IMAGE}:.*|${FRONTEND_IMAGE}:${IMAGE_TAG}|" docker-compose.yaml &&
                        sed -i "s|${BACKEND_IMAGE}:.*|${BACKEND_IMAGE}:${IMAGE_TAG}|" docker-compose.yaml &&

                        docker compose pull &&
                        docker compose down &&
                        docker compose up -d
                    '
                    """

                    sh """
                    curl -X POST -H 'Content-type: application/json' \
                    --data '{"text": "üöÄ Deployment Successful on AWS EC2 (${AWS_IP})"}' \
                    '${SLACK_WEBHOOK}'
                    """
                }
            }
        }
    }

    post {
        failure {
            sh """
            curl -X POST -H 'Content-type: application/json' \
            --data '{"text": "‚ùå Pipeline Failed!"}' \
            '${SLACK_WEBHOOK}'
            """
        }
    }
}
